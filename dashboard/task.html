<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>টাস্ক বিস্তারিত</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri&family=Noto+Sans+Bengali&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body>

<div class="header">
  <h2>টাস্ক বিস্তারিত</h2>
</div>

<div id="taskDetail" class="card" style="margin: 20px;">
  <p>তথ্য লোড হচ্ছে...</p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD5wCkpL3LghaFrBf3YxGQ8I1ig1wbSn3A", // আপনার Firebase API Key
    authDomain: "subscribe-bot-6f9b2.firebaseapp.com",
    databaseURL: "https://subscribe-bot-6f9b2-default-rtdb.firebaseio.com",
    projectId: "subscribe-bot-6f9b2",
    storageBucket: "subscribe-bot-6f9b2.appspot.com",
    messagingSenderId: "141787931031",
    appId: "1:141787931031:web:2108a3e930f5ce4fbc64d2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // আপনার YouTube Data API Key এখানে বসান
  const YOUTUBE_API_KEY = "YOUR_YOUTUBE_API_KEY_HERE"; // <-- এটি আপনার YouTube API Key!

  // URL থেকে taskId নেওয়ার ফাংশন
  function getTaskId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('taskId');
  }

  let currentUserId = null; // ইউজার আইডি এখানে সংরক্ষণ করা হবে

  // YouTube Channel URL থেকে Channel ID বের করার ফাংশন
  function extractChannelId(url) {
    const channelIdMatch = url.match(/(?:youtube\.com\/(?:channel\/|user\/|c\/)|youtu\.be\/|youtube\.com\/watch\?v=.*?&channel=)([\w-]{24}|[\w-]+)/);
    if (channelIdMatch && channelIdMatch[1]) {
      // যদি URL channel ID ফরম্যাটে থাকে (UC...)
      if (channelIdMatch[1].startsWith('UC')) {
        return channelIdMatch[1];
      }
      // যদি URL user বা c ফরম্যাটে থাকে, সরাসরি Channel ID না হলেও API-কে পাঠানোর চেষ্টা করবে
      // তবে সেরা পদ্ধতি হলো Firebase-এ সরাসরি Channel ID সংরক্ষণ করা
      console.warn("সরাসরি Channel ID পাওয়া যায়নি। ইউআরএল থেকে এক্সট্র্যাক্ট করার চেষ্টা করা হচ্ছে। নিশ্চিত করুন যে ch.link এ Channel ID আছে অথবা আপনি তা Firebase-এ সরাসরি সংরক্ষণ করছেন।");
      return channelIdMatch[1]; // এই ক্ষেত্রে এটি ইউজারনেম বা কাস্টম URL হতে পারে
    }
    return null;
  }

  // YouTube API থেকে সাবস্ক্রাইবার সংখ্যা আনার ফাংশন
  async function getYouTubeSubscriberCount(channelId, youtubeApiKey) {
    if (!channelId) {
        console.error("Channel ID পাওয়া যায়নি।");
        throw new Error("Channel ID পাওয়া যায়নি।");
    }
    if (!youtubeApiKey || youtubeApiKey === "AIzaSyD5wCkpL3LghaFrBf3YxGQ8I1ig1wbSn3A") {
        console.error("YouTube API Key সেট করা হয়নি।");
        throw new Error("YouTube API Key সেট করা হয়নি।");
    }

    const apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&fields=items%2Fstatistics%2FsubscriberCount&key=${youtubeApiKey}`;

    try {
      const response = await fetch(apiUrl);
      const data = await response.json();

      if (response.ok && data.items && data.items.length > 0) {
        return parseInt(data.items[0].statistics.subscriberCount, 10);
      } else {
        console.error("YouTube API ত্রুটি:", data);
        throw new Error(data.error ? data.error.message : "সাবস্ক্রাইবার ডেটা লোড করা যায়নি।");
      }
    } catch (error) {
      console.error("YouTube API কল করতে সমস্যা:", error);
      throw new Error("সাবস্ক্রাইবার সংখ্যা পেতে ব্যর্থ।");
    }
  }


  // টাস্ক ডেটা লোড এবং প্রদর্শন
  function loadTaskDetail(taskId) {
    if (!taskId) {
      document.getElementById('taskDetail').innerHTML = "<p>টাস্ক আইডি পাওয়া যায়নি।</p>";
      return;
    }

    if (!currentUserId) {
        return; // ইউজার আইডি না পাওয়া গেলে, onAuthStateChanged হ্যান্ডেল করবে
    }

    db.ref('tasks/' + taskId).once('value')
      .then(snap => {
        const ch = snap.val();
        if (!ch) {
          document.getElementById('taskDetail').innerHTML = "<p>টাস্ক পাওয়া যায়নি।</p>";
          return;
        }

        const taskDetailDiv = document.getElementById('taskDetail');
        taskDetailDiv.innerHTML = `
          <h3>${ch.title}</h3>
          <p><strong>সাবস্ক্রাইবার:</strong> <span id="currentCompleted">${ch.completed}</span> / ${ch.max}</p>
          <div class="progress">
            <div class="progress-bar" style="width: ${(ch.completed / ch.max) * 100}%"></div>
          </div>
          <p style="margin-top: 15px;">${ch.description || "বিস্তারিত তথ্য উপলব্ধ নেই।"}</p>
          <div id="initialButtons" style="margin-top: 20px;">
            <button id="showChannelLinkBtn" class="btn btn-primary">চ্যানেলের লিংক</button>
            <a href="index.html" class="btn btn-danger" style="margin-left: 10px;">⬅️ ড্যাশবোর্ডে ফিরে যাও</a>
          </div>
          <div id="channelLinkSection" style="display: none; margin-top: 20px;">
            <p>চ্যানেলের লিংক: <a href="${ch.link}" target="_blank">${ch.link}</a></p>
            <a href="${ch.link}" target="_blank" class="btn btn-primary" style="margin-top: 10px; display: inline-block;">➡️ সাবস্ক্রাইব করতে এখানে ক্লিক করো</a>
            <button id="doneBtn" class="btn btn-success" style="margin-top: 10px; margin-left: 10px;">Done ✅</button>
          </div>
          <div id="confirmationSection" style="display: none; margin-top: 20px;">
            <p>আপনি কি সত্যিই সাবস্ক্রাইব করেছেন?</p>
            <button id="iHaveSubscribedBtn" class="btn btn-success">আমি সাবস্ক্রাইব করেছি</button>
          </div>
        `;

        const showChannelLinkBtn = document.getElementById('showChannelLinkBtn');
        const doneBtn = document.getElementById('doneBtn');
        const iHaveSubscribedBtn = document.getElementById('iHaveSubscribedBtn');
        const initialButtons = document.getElementById('initialButtons');
        const channelLinkSection = document.getElementById('channelLinkSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const currentCompletedSpan = document.getElementById('currentCompleted');

        // প্রথম বাটন ক্লিক করলে beforeCount সংরক্ষণ করুন
        showChannelLinkBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                alert('অনুগ্রহ করে লগইন করুন।');
                return;
            }
            initialButtons.style.display = 'none';
            channelLinkSection.style.display = 'block';

            try {
                const channelId = extractChannelId(ch.link);
                if (!channelId) {
                    alert('চ্যানেল আইডি পাওয়া যায়নি। অনুগ্রহ করে লিংকটি পরীক্ষা করুন।');
                    return;
                }

                // YouTube API থেকে beforeCount নিন
                const beforeCount = await getYouTubeSubscriberCount(channelId, YOUTUBE_API_KEY);
                
                // Firebase এ beforeCount সংরক্ষণ করুন
                await db.ref('users/' + currentUserId + '/taskProgress/' + taskId).set({
                    beforeCount: beforeCount,
                    status: 'started', // কাজের অবস্থা সেট করুন
                    startTime: firebase.database.ServerValue.TIMESTAMP // সময় সংরক্ষণ করুন
                });
                console.log("Before count Firebase এ সংরক্ষণ করা হয়েছে:", beforeCount);
            } catch (error) {
                console.error("beforeCount সংরক্ষণ করতে সমস্যা হয়েছে:", error);
                alert('সাবস্ক্রাইবার সংখ্যা লোড করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        });

        doneBtn.addEventListener('click', () => {
          channelLinkSection.style.display = 'none';
          confirmationSection.style.display = 'block';
        });

        // "আমি সাবস্ক্রাইব করেছি" বাটনে ক্লিক করলে চেক ও আপডেট করুন
        iHaveSubscribedBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                alert('ব্যবহারকারীর তথ্য পাওয়া যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন বা লগইন করুন।');
                console.error("currentUserId is null. User not authenticated or not loaded yet.");
                return;
            }

            try {
                // Firebase থেকে পূর্বে সংরক্ষণ করা beforeCount নিয়ে আসুন
                const taskProgressSnap = await db.ref('users/' + currentUserId + '/taskProgress/' + taskId).once('value');
                const taskProgress = taskProgressSnap.val();

                if (!taskProgress || taskProgress.status !== 'started' || typeof taskProgress.beforeCount !== 'number') {
                    alert('আপনার টাস্ক শুরু হয়নি বা পূর্বে সাবস্ক্রাইব করার কাউন্ট পাওয়া যায়নি। অনুগ্রহ করে চ্যানেলের লিংকে ক্লিক করে শুরু করুন।');
                    return;
                }

                const beforeCount = taskProgress.beforeCount;
                const channelId = extractChannelId(ch.link);
                if (!channelId) {
                    alert('চ্যানেল আইডি পাওয়া যায়নি। অনুগ্রহ করে লিংকটি পরীক্ষা করুন।');
                    return;
                }

                // YouTube API থেকে নতুন কাউন্ট নিন
                const newCount = await getYouTubeSubscriberCount(channelId, YOUTUBE_API_KEY);

                if (newCount > beforeCount) {
                    // সাবস্ক্রাইবার সংখ্যা বেড়েছে, পয়েন্ট দিন এবং টাস্ক আপডেট করুন
                    await Promise.all([
                        db.ref('tasks/' + taskId).transaction(currentData => {
                            if (currentData) {
                                if (currentData.completed < currentData.max) {
                                    currentData.completed = (currentData.completed || 0) + 1;
                                }
                            }
                            return currentData;
                        }),
                        db.ref('users/' + currentUserId + '/points').transaction(currentPoints => {
                            return (currentPoints || 0) + 1; // 1 পয়েন্ট যোগ করুন
                        }),
                        // টাস্কের অবস্থা 'completed' এ আপডেট করুন
                        db.ref('users/' + currentUserId + '/taskProgress/' + taskId).update({
                            status: 'completed',
                            completionTime: firebase.database.ServerValue.TIMESTAMP
                        })
                    ]);

                    alert('আপনার সাবস্ক্রিপশন নিশ্চিত করার জন্য ধন্যবাদ! সংখ্যা ও পয়েন্ট আপডেট করা হয়েছে।');
                    // UI আপডেট করুন
                    db.ref('tasks/' + taskId).once('value').then(updatedSnap => {
                      const updatedCh = updatedSnap.val();
                      if (updatedCh) {
                          currentCompletedSpan.textContent = updatedCh.completed;
                          document.querySelector('.progress-bar').style.width = `${(updatedCh.completed / updatedCh.max) * 100}%`;
                      }
                    });
                    window.location.href = 'index.html'; // ড্যাশবোর্ডে ফিরে যান

                } else {
                    // সাবস্ক্রাইবার সংখ্যা বাড়েনি
                    alert('মনে হচ্ছে আপনি এখনও সাবস্ক্রাইব করেননি। অনুগ্রহ করে প্রথমে চ্যানেলটি সাবস্ক্রাইব করুন, তারপর এই বাটন চাপুন।');
                }

            } catch (error) {
                console.error("যাচাই বা ডেটা আপডেট করতে সমস্যা হয়েছে:", error);
                alert('যাচাইকরণে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        });

      })
      .catch(err => {
        console.error(err);
        document.getElementById('taskDetail').innerHTML = "<p>ডেটা লোড করতে সমস্যা হয়েছে।</p>";
      });
  }

  // Firebase Authentication স্টেট পরিবর্তনের জন্য অপেক্ষা করুন
  firebase.auth().onAuthStateChanged(user => {
      if (user) {
          // ব্যবহারকারী লগইন করা থাকলে, তার UID নিন
          currentUserId = user.uid;
          console.log("লগইন করা ব্যবহারকারীর আইডি:", currentUserId);
          // ইউজার আইডি পাওয়ার পর টাস্কের বিস্তারিত লোড করুন
          loadTaskDetail(getTaskId());
      } else {
          // ব্যবহারকারী লগইন করা না থাকলে
          console.log("কোনো ব্যবহারকারী লগইন করা নেই।");
          document.getElementById('taskDetail').innerHTML = "<p>এই টাস্কটি দেখতে হলে আপনাকে লগইন করতে হবে।</p>";
          // আপনি চাইলে এখানে ব্যবহারকারীকে লগইন পেজে রিডাইরেক্ট করতে পারেন:
          // window.location.href = "login.html";
      }
  });
</script>

</body>
</html>
