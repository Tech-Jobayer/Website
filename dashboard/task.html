<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>টাস্ক বিস্তারিত</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri&family=Noto+Sans+Bengali&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body>

<div class="header">
  <h2>টাস্ক বিস্তারিত</h2>
</div>

<div id="taskDetail" class="card" style="margin: 20px;">
  <p>তথ্য লোড হচ্ছে...</p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAC4h55aA0Zz--V5ejyndzR5WC_-9rAPio",
    authDomain: "subscribe-bot-6f9b2.firebaseapp.com",
    databaseURL: "https://subscribe-bot-6f9b2-default-rtdb.firebaseio.com",
    projectId: "subscribe-bot-6f9b2",
    storageBucket: "subscribe-bot-6f9b2.appspot.com",
    messagingSenderId: "141787931031",
    appId: "1:141787931031:web:2108a3e930f5ce4fbc64d2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // URL থেকে taskId নেওয়ার ফাংশন
  function getTaskId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('taskId');
  }

  let currentUserId = null; // ইউজার আইডি এখানে সংরক্ষণ করা হবে

  // টাস্ক ডেটা লোড এবং প্রদর্শন
  function loadTaskDetail(taskId) {
    if (!taskId) {
      document.getElementById('taskDetail').innerHTML = "<p>টাস্ক আইডি পাওয়া যায়নি।</p>";
      return;
    }

    // নিশ্চিত করুন যে ইউজার আইডি পাওয়া গেছে
    if (!currentUserId) {
        // যদি ইউজার আইডি না পাওয়া যায়, তবে loadTaskDetail() function এর
        // বাইরে onAuthStateChanged এ handle করা হবে।
        // এই ক্ষেত্রে, এখানে কিছু করার দরকার নেই, শুধু রিটার্ন করে দেওয়া হলো
        return;
    }

    db.ref('tasks/' + taskId).once('value')
      .then(snap => {
        const ch = snap.val();
        if (!ch) {
          document.getElementById('taskDetail').innerHTML = "<p>টাস্ক পাওয়া যায়নি।</p>";
          return;
        }

        const taskDetailDiv = document.getElementById('taskDetail');
        taskDetailDiv.innerHTML = `
          <h3>${ch.title}</h3>
          <p><strong>সাবস্ক্রাইবার:</strong> <span id="currentCompleted">${ch.completed}</span> / ${ch.max}</p>
          <div class="progress">
            <div class="progress-bar" style="width: ${(ch.completed / ch.max) * 100}%"></div>
          </div>
          <p style="margin-top: 15px;">${ch.description || "বিস্তারিত তথ্য উপলব্ধ নেই।"}</p>
          <div id="initialButtons" style="margin-top: 20px;">
            <button id="showChannelLinkBtn" class="btn btn-primary">চ্যানেলের লিংক</button>
            <a href="index.html" class="btn btn-danger" style="margin-left: 10px;">⬅️ ড্যাশবোর্ডে ফিরে যাও</a>
          </div>
          <div id="channelLinkSection" style="display: none; margin-top: 20px;">
            <p>চ্যানেলের লিংক: <a href="${ch.link}" target="_blank">${ch.link}</a></p>
            <a href="${ch.link}" target="_blank" class="btn btn-primary" style="margin-top: 10px; display: inline-block;">➡️ সাবস্ক্রাইব করতে এখানে ক্লিক করো</a>
            <button id="doneBtn" class="btn btn-success" style="margin-top: 10px; margin-left: 10px;">Done ✅</button>
          </div>
          <div id="confirmationSection" style="display: none; margin-top: 20px;">
            <p>আপনি কি সত্যিই সাবস্ক্রাইব করেছেন?</p>
            <button id="iHaveSubscribedBtn" class="btn btn-success">আমি সাবস্ক্রাইব করেছি</button>
          </div>
        `;

        const showChannelLinkBtn = document.getElementById('showChannelLinkBtn');
        const doneBtn = document.getElementById('doneBtn');
        const iHaveSubscribedBtn = document.getElementById('iHaveSubscribedBtn');
        const initialButtons = document.getElementById('initialButtons');
        const channelLinkSection = document.getElementById('channelLinkSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const currentCompletedSpan = document.getElementById('currentCompleted');

        showChannelLinkBtn.addEventListener('click', () => {
          initialButtons.style.display = 'none';
          channelLinkSection.style.display = 'block';
        });

        doneBtn.addEventListener('click', () => {
          channelLinkSection.style.display = 'none';
          confirmationSection.style.display = 'block';
        });

        iHaveSubscribedBtn.addEventListener('click', () => {
          // সাবস্ক্রাইব সংখ্যা এবং পয়েন্ট উভয়ই আপডেট করার জন্য প্রমিস.অল ব্যবহার করা হয়েছে
          // নিশ্চিত করুন যে currentUserId পাওয়া গেছে
          if (!currentUserId) {
            alert('ব্যবহারকারীর তথ্য পাওয়া যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন বা লগইন করুন।');
            console.error("currentUserId is null. User not authenticated or not loaded yet.");
            return;
          }

          Promise.all([
            // টাস্কের 'completed' সংখ্যা আপডেট করুন
            db.ref('tasks/' + taskId).transaction(currentData => {
              if (currentData) {
                if (currentData.completed < currentData.max) { // নিশ্চিত করুন যে max অতিক্রম না করে
                  currentData.completed = (currentData.completed || 0) + 1;
                }
              }
              return currentData;
            }),
            // ইউজারের 'points' আপডেট করুন
            db.ref('users/' + currentUserId + '/points').transaction(currentPoints => {
              // যদি বর্তমান পয়েন্ট না থাকে, তাহলে ০ থেকে শুরু করুন, এবং ১ যোগ করুন
              return (currentPoints || 0) + 1;
            })
          ])
          .then(() => {
            alert('আপনার সাবস্ক্রিপশন নিশ্চিত করার জন্য ধন্যবাদ! সংখ্যা ও পয়েন্ট আপডেট করা হয়েছে।');
            // UI আপডেট করুন
            db.ref('tasks/' + taskId).once('value').then(updatedSnap => {
              const updatedCh = updatedSnap.val();
              if (updatedCh) {
                currentCompletedSpan.textContent = updatedCh.completed;
                document.querySelector('.progress-bar').style.width = `${(updatedCh.completed / updatedCh.max) * 100}%`;
              }
            });
            window.location.href = 'index.html'; // ড্যাশবোর্ডে ফিরে যান
          })
          .catch(error => {
            console.error("ডেটা আপডেট করতে সমস্যা হয়েছে:", error);
            alert('সাবস্ক্রিপশন বা পয়েন্ট আপডেট করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
          });
        });

      })
      .catch(err => {
        console.error(err);
        document.getElementById('taskDetail').innerHTML = "<p>ডেটা লোড করতে সমস্যা হয়েছে।</p>";
      });
  }

  // Firebase Authentication স্টেট পরিবর্তনের জন্য অপেক্ষা করুন
  firebase.auth().onAuthStateChanged(user => {
      if (user) {
          // ব্যবহারকারী লগইন করা থাকলে, তার UID নিন
          currentUserId = user.uid;
          console.log("লগইন করা ব্যবহারকারীর আইডি:", currentUserId);
          // ইউজার আইডি পাওয়ার পর টাস্কের বিস্তারিত লোড করুন
          loadTaskDetail(getTaskId());
      } else {
          // ব্যবহারকারী লগইন করা না থাকলে
          console.log("কোনো ব্যবহারকারী লগইন করা নেই।");
          document.getElementById('taskDetail').innerHTML = "<p>এই টাস্কটি দেখতে হলে আপনাকে লগইন করতে হবে।</p>";
          // আপনি চাইলে এখানে ব্যবহারকারীকে লগইন পেজে রিডাইরেক্ট করতে পারেন:
          // window.location.href = "login.html";
      }
  });
</script>

</body>
</html>
