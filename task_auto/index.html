<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>ржЯрж╛рж╕рзНржХ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri&family=Noto+Sans+Bengali&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body>
<div id="notificationDrawer" class="notification-drawer">
  <button class="closebtn" onclick="closeNotificationDrawer()">&times;</button>
  <div class="drawer-header">
    <h3>ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржирж╕</h3>
  </div>
  <div id="notificationList" class="notification-list">
    <p class="no-notifications-message">ржХрзЛржирзЛ ржирждрзБржи ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи ржирзЗржЗред</p>
  </div>
</div>

  <div id="sidebar" class="sidebar">
    <button class="closebtn" onclick="closeSidebar()">&times;</button>
    <a href="/Website/dashboard/">ЁЯПа ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</a>
    <a href="/Website/profile/">ЁЯСд ржкрзНрж░рзЛржлрж╛ржЗрж▓</a>
    <a href="/Website/tasks/">ЁЯУЭ ржЯрж╛рж╕рзНржХ</a>
    <a href="/Website/rewards/">ЁЯОБ рж░рж┐ржУржпрж╝рж╛рж░рзНржб</a>
    <a href="/Website/buy-subscribe/">ЁЯЫТрж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржХрж┐ржирзБржи</a>
    <a href="/Website/support/">ЁЯУЮ рж╕рж╛ржкрзЛрж░рзНржЯ</a>
  </div>

  <div id="profileDrawer" class="profile-drawer">
    <button class="closebtn" onclick="closeProfileDrawer()">&times;</button>
    <div class="profile-info">
      <img id="drawerProfileImg" src="https://raw.githubusercontent.com/tech-jobayer/Website/main/data/default-profile.png" alt="Profile" class="profile-img-large">
      <h3 id="drawerUserName">Guest User</h3>
      <p id="drawerUserEmail">Not logged in</p>
      <p id="drawerUserPoints">ЁЯФе 0 ржкржпрж╝рзЗржирзНржЯ</p>
      <div class="profile-actions">
        <button id="drawerLoginSignupBtn" class="btn" onclick="redirectToLogin()">ЁЯФР Login / Signup</button>
        <button id="drawerLogoutBtn" class="btn" onclick="logout()" style="display: none;">ЁЯЪк Logout</button>
      </div>
    </div>
    <div class="profile-drawer-links">
        <a href="/Website/profile/">ЁЯСд ржкрзНрж░рзЛржлрж╛ржЗрж▓ рж╕рзЗржЯрж┐ржВрж╕</a>
        <a href="/Website/rewards/">ЁЯОБ ржЖржорж╛рж░ рж░рж┐ржУржпрж╝рж╛рж░рзНржб</a>
    </div>
  </div>

  <div class="header">
  <button id="menuBtn" class="menu-btn">&#9776;</button>
  <button id="notifyBtn" class="notify-btn">
    ЁЯФФ
    <span class="notify-count">0</span>
  </button>
  <h2>JOBAYER</h2>
  <span id="headerUserPoints" class="header-user-points">
    </span>
  <button id="profileBtn" class="profile-btn">
   <img id="profileImg" src="https://raw.githubusercontent.com/tech-jobayer/Website/main/data/default-profile.png" alt="Profile" class="profile-img">
  </button>
</div>

  <div id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи</div>
  </div>
<div class="header">
  <h2>ржЯрж╛рж╕рзНржХ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд</h2>
</div>

<div id="taskDetail" class="card" style="margin: 20px;">
  <p>рждржерзНржп рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAC4h55aA0Zz--V5ejyndzR5WC_-9rAPio",
    authDomain: "subscribe-bot-6f9b2.firebaseapp.com",
    databaseURL: "https://subscribe-bot-6f9b2-default-rtdb.firebaseio.com",
    projectId: "subscribe-bot-6f9b2",
    storageBucket: "subscribe-bot-6f9b2.appspot.com",
    messagingSenderId: "141787931031",
    appId: "1:141787931031:web:2108a3e930f5ce4fbc64d2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const YOUTUBE_API_KEY = "AIzaSyD5wCkpL3LghaFrBf3YxGQ8I1ig1wbSn3A";

  function getTaskId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('taskId');
  }

  let currentUserId = null;

  function extractChannelId(url) {
    const channelIdMatch = url.match(/(?:youtube\.com\/(?:channel\/|user\/|c\/)|youtu\.be\/|youtube\.com\/watch\?v=.*?&channel=)([\w-]{24}|[\w-]+)/);
    if (channelIdMatch && channelIdMatch[1]) {
      return channelIdMatch[1];
    }
    return null;
  }

  async function getYouTubeSubscriberCount(channelId, youtubeApiKey) {
    const apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&fields=items%2Fstatistics%2FsubscriberCount&key=${youtubeApiKey}`;
    const response = await fetch(apiUrl);
    const data = await response.json();
    if (response.ok && data.items && data.items.length > 0) {
      return parseInt(data.items[0].statistics.subscriberCount, 10);
    } else {
      console.error("YouTube API error:", data);
      throw new Error("рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржмрж╛рж░ ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рж╛ ржпрж╛ржпрж╝ржирж┐ред");
    }
  }

  function loadTaskDetail(taskId) {
    if (!taskId) {
      document.getElementById('taskDetail').innerHTML = "<p>ржЯрж╛рж╕рзНржХ ржЖржЗржбрж┐ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред</p>";
      return;
    }

    db.ref('tasks/' + taskId).once('value')
      .then(snap => {
        const ch = snap.val();
        if (!ch) {
          document.getElementById('taskDetail').innerHTML = "<p>ржЯрж╛рж╕рзНржХ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред</p>";
          return;
        }

        const taskDetailDiv = document.getElementById('taskDetail');
        taskDetailDiv.innerHTML = `
          <h3>${ch.title}</h3>
          <p><strong>рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржмрж╛рж░:</strong> <span id="currentCompleted">${ch.completed}</span> / ${ch.max}</p>
          <div class="progress">
            <div class="progress-bar" style="width: ${(ch.completed / ch.max) * 100}%"></div>
          </div>
          <p style="margin-top: 15px;">${ch.description || "ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд рждржерзНржп ржЙржкрж▓ржмрзНржз ржирзЗржЗред"}</p>
          <div id="initialButtons" style="margin-top: 20px;">
            <button id="showChannelLinkBtn" class="btn btn-primary">ржЪрзНржпрж╛ржирзЗрж▓рзЗрж░ рж▓рж┐ржВржХ</button>
            <a href="/Website/dashboard" class="btn btn-danger" style="margin-left: 10px;">тмЕя╕П ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржбрзЗ ржлрж┐рж░рзЗ ржпрж╛ржУ</a>
          </div>
          <div id="channelLinkSection" style="display: none; margin-top: 20px;"></div>
          <div id="confirmationSection" style="display: none; margin-top: 20px;"></div>
        `;

        const showChannelLinkBtn = document.getElementById('showChannelLinkBtn');
        const channelLinkSection = document.getElementById('channelLinkSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const currentCompletedSpan = document.getElementById('currentCompleted');

        showChannelLinkBtn.addEventListener('click', async () => {
          if (!currentUserId) {
            alert('ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ рж▓ржЧржЗржи ржХрж░рзБржиред');
            return;
          }

          document.getElementById('initialButtons').style.display = 'none';
          channelLinkSection.style.display = 'block';

          try {
            const channelId = extractChannelId(ch.link);
            if (!channelId) {
              alert('ржЪрзНржпрж╛ржирзЗрж▓ ржЖржЗржбрж┐ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред');
              return;
            }

            const beforeCount = await getYouTubeSubscriberCount(channelId, YOUTUBE_API_KEY);

            await db.ref('users/' + currentUserId + '/taskProgress/' + taskId).set({
              beforeCount: beforeCount,
              status: 'started',
              startTime: firebase.database.ServerValue.TIMESTAMP
            });

            channelLinkSection.innerHTML = `
              <p>ржЪрзНржпрж╛ржирзЗрж▓рзЗрж░ рж▓рж┐ржВржХ: <a href="${ch.link}" target="_blank">${ch.link}</a></p>
              <p id="beforeCountDisplay">ЁЯФв рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржмрж╛рж░ рж╕ржВржЦрзНржпрж╛ (рж╢рзБрж░рзБрж░ рж╕ржоржпрж╝): ${beforeCount}</p>
              <a href="${ch.link}" target="_blank" class="btn btn-primary" style="margin-top: 10px;">тЮбя╕П рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржХрж░рждрзЗ ржПржЦрж╛ржирзЗ ржХрзНрж▓рж┐ржХ ржХрж░рзЛ</a>
              <button id="doneBtn" class="btn btn-success" style="margin-top: 10px; margin-left: 10px;">Done тЬЕ</button>
            `;

            document.getElementById('doneBtn').addEventListener('click', () => {
              channelLinkSection.style.display = 'none';
              confirmationSection.style.display = 'block';
              confirmationSection.innerHTML = `
                <p>ржЖржкржирж┐ ржХрж┐ рж╕рждрзНржпрж┐ржЗ рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржХрж░рзЗржЫрзЗржи?</p>
                <button id="iHaveSubscribedBtn" class="btn btn-success">ржЖржорж┐ рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржХрж░рзЗржЫрж┐</button>
              `;
              document.getElementById('iHaveSubscribedBtn').addEventListener('click', async () => {
                try {
                  const taskProgressSnap = await db.ref('users/' + currentUserId + '/taskProgress/' + taskId).once('value');
                  const taskProgress = taskProgressSnap.val();
                  if (!taskProgress || taskProgress.status !== 'started') {
                    alert('ржЖржкржирж╛рж░ ржЯрж╛рж╕рзНржХ рж╢рзБрж░рзБ рж╣ржпрж╝ржирж┐ред');
                    return;
                  }

                  const beforeCount = taskProgress.beforeCount;
                  const newCount = await getYouTubeSubscriberCount(channelId, YOUTUBE_API_KEY);

                  confirmationSection.innerHTML += `<p>ЁЯФБ ржмрж░рзНрждржорж╛ржи рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржмрж╛рж░ рж╕ржВржЦрзНржпрж╛: ${newCount}</p>`;

                  const difference = newCount - beforeCount;
                  if (difference > 0) {
                    confirmationSection.innerHTML += `<p style="color:green;">ЁЯОЙ рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржмрзЗржбрж╝рзЗржЫрзЗ: ${difference} ржЬржи</p>`;

                    await Promise.all([
                      db.ref('tasks/' + taskId).transaction(data => {
                        if (data && data.completed < data.max) {
                          data.completed += 1;
                        }
                        return data;
                      }),
                      db.ref('users/' + currentUserId + '/points').transaction(points => (points || 0) + 1),
                      db.ref('users/' + currentUserId + '/taskProgress/' + taskId).update({
                        status: 'completed',
                        completionTime: firebase.database.ServerValue.TIMESTAMP
                      })
                    ]);

                    db.ref('tasks/' + taskId).once('value').then(updatedSnap => {
                      const updatedCh = updatedSnap.val();
                      if (updatedCh) {
                        currentCompletedSpan.textContent = updatedCh.completed;
                        document.querySelector('.progress-bar').style.width = `${(updatedCh.completed / updatedCh.max) * 100}%`;
                      }
                    });

                    alert('тЬЕ рж╕рж╛ржмрж╕рзНржХрзНрж░рж┐ржкрж╢ржи рж╕ржлрж▓! ржЖржкржирж╛ржХрзЗ 1 ржкржпрж╝рзЗржирзНржЯ ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝рзЗржЫрзЗред');
                    window.location.href = 'index.html';
                  } else {
                    confirmationSection.innerHTML += `<p style="color:red;">тЪая╕П рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм рж╕ржВржЦрзНржпрж╛ ржмрж╛ржбрж╝рзЗржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржХрж░рзБржиред</p>`;
                    alert('рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржирж┐рж╢рзНржЪрж┐ржд рж╣ржпрж╝ржирж┐ред ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред');
                  }
                } catch (err) {
                  console.error(err);
                  alert('рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред');
                }
              });
            });

          } catch (error) {
            console.error(error);
            alert('рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржмрж╛рж░ рж╕ржВржЦрзНржпрж╛ рж▓рзЛржб ржХрж░рждрзЗ ржмрзНржпрж░рзНржеред');
          }
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('taskDetail').innerHTML = "<p>ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред</p>";
      });
  }

  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      currentUserId = user.uid;
      loadTaskDetail(getTaskId());
    } else {
      document.getElementById('taskDetail').innerHTML = "<p>ржПржЗ ржЯрж╛рж╕рзНржХржЯрж┐ ржжрзЗржЦрждрзЗ рж╣рж▓рзЗ ржЖржкржирж╛ржХрзЗ рж▓ржЧржЗржи ржХрж░рждрзЗ рж╣ржмрзЗред</p>";
    }
  });
</script>

</body>
</html>
